<!DOCTYPE html>
<html>
<head>
  <title>Interactive Map with Markers</title>
  <style>
    #map {
      height: 400px;
      width: 100%;
    }
  </style>
  <!-- Include Leaflet CSS and JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <h1>Water Sources Map</h1>
  <div id="map"></div>

  <script>
    // Initialize the map
    var map = L.map('map').setView([47.3, 9], 8);

    // Add OpenStreetMap as the base map
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Function to fetch additional data when marker is clicked
    function fetchAdditionalData(marker) {
      // 1. Fetch location details from OpenStreetMap using Nominatim API
      fetch(`https://nominatim.openstreetmap.org/reverse?lat=${marker.lat}&lon=${marker.lng}&format=json`)
        .then(response => response.json())
        .then(openStreetMapData => {
          const locationName = openStreetMapData.display_name;
          const countryCode = openStreetMapData.address.country_code;

          // 2. Fetch data from OSM Overpass API for water-related features (e.g., rivers, lakes) near the clicked marker
          fetch(`https://overpass-api.de/api/interpreter?data=[out:json];(way(around:1000,${marker.lat},${marker.lng})[waterway~"river|lake|stream|canal|pond"];);out;`)
            .then(response => response.json())
            .then(osmData => {
              const waterFeatures = osmData.elements;

              // 3. Fetch World Bank water data based on the country code from OpenStreetMap
              fetch(`http://api.worldbank.org/v2/country/${countryCode}/indicator/SH.H2O.BASW.ZS?date=latest&format=json`)
                .then(response => response.json())
                .then(worldBankData => {
                  const waterIndicatorValue = worldBankData[1][0].value;

                  // Now you can use locationName, waterFeatures, and waterIndicatorValue for display
                  console.log('Location Name:', locationName);
                  console.log('Water Features:', waterFeatures);
                  console.log('Water Indicator Value:', waterIndicatorValue);
                })
                .catch(error => {
                  console.error('Error fetching World Bank data:', error);
                });
            })
            .catch(error => {
              console.error('Error fetching OSM Overpass data:', error);
            });
        })
        .catch(error => {
          console.error('Error fetching OpenStreetMap data:', error);
        });
    }

    // Sample marker data (you can replace this with your fetched data)
    var markerData = { lat: 47.3, lng: 9, name: 'Sample Water Source' };

    // Create marker for the sample data
    var marker = L.marker([parseFloat(markerData.lat), parseFloat(markerData.lng)]).addTo(map);
    marker.bindPopup(`<h2>${markerData.name}</h2>`);

    // Fetch additional data when marker is clicked
    marker.on('click', function() {
      fetchAdditionalData(markerData);
    });
  </script>
</body>
</html>
